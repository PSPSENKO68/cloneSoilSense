<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ SoilSense Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    #map {
      height: 100vh;
      width: 100%;
    }

    .red-marker {
      background: #ef4444;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid white;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans">

  <!-- Header -->
  <header class="fixed top-0 w-full z-10 bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold text-blue-600">ğŸŒ SoilSense Map</h1>
      <span class="text-sm text-gray-500">Theo dÃµi cáº£m biáº¿n thá»i gian thá»±c</span>
    </div>
  </header>

  <!-- Báº£n Ä‘á»“ -->
  <div id="map" class="mt-14"></div>

  <script>
    // ğŸŒ Khá»Ÿi táº¡o báº£n Ä‘á»“ Leaflet
    const map = L.map("map").setView([10.7769, 106.7009], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    // ğŸ“¦ Dá»¯ liá»‡u tá»« backend (EJS)
    const data = <%- JSON.stringify(data || []) %>;
    console.log("ğŸ“¡ Sensor data:", data);

    const redIcon = L.divIcon({ className: "red-marker", iconSize: [16, 16] });

    // ğŸ§­ Táº¡o marker cho tá»«ng tá»a Ä‘á»™
    data.forEach(d => {
      if (!d.records || d.records.length === 0) return;

      const latest = d.records[d.records.length - 1];
      const latestCond = latest.conductivity ?? "N/A";

      const marker = L.marker([d.latitude, d.longitude], { icon: redIcon })
        .addTo(map)
        .bindTooltip(`âš¡ ${latestCond}`, { permanent: true, direction: "top" });

      const popup = L.popup({ maxWidth: 500 });
      marker.bindPopup(popup);

      // Khi click marker â†’ render báº£ng dá»¯ liá»‡u
      marker.on("click", () => {
        let tableRows = "";
        d.records.forEach((rec, i) => {
          const time = new Date(rec.timestamp).toLocaleString("vi-VN");
          tableRows += `
            <tr class="hover:bg-gray-100">
              <td class="px-3 py-2">${rec.temperature ?? "N/A"}Â°C</td>
              <td class="px-3 py-2">${rec.humidity ?? "N/A"}%</td>
              <td class="px-3 py-2">${rec.conductivity ?? "N/A"}</td>
              <td class="px-3 py-2">${time}</td>
              <td class="px-3 py-2">
                <button 
                  class="view-detail-btn bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-md" 
                  data-lat="${d.latitude}" 
                  data-lon="${d.longitude}" 
                  data-index="${i}">
                  Xem
                </button>
              </td>
            </tr>`;
        });

        const popupHtml = `
          <div id="popup-${d.latitude}-${d.longitude}" class="p-2">
            <h2 class="font-semibold text-blue-600 mb-2">
              ğŸ“ Tá»a Ä‘á»™: ${d.latitude.toFixed(6)}, ${d.longitude.toFixed(6)}
            </h2>
            <p class="text-sm text-gray-600 mb-3">
              ğŸ“… Sá»‘ láº§n Ä‘o: <b>${d.records.length}</b>
            </p>
            <div class="overflow-x-auto">
              <table class="min-w-full border text-sm text-gray-700">
                <thead class="bg-gray-200">
                  <tr>
                    <th class="px-3 py-2 border">ğŸŒ¡ Nhiá»‡t Ä‘á»™ (Â°C)</th>
                    <th class="px-3 py-2 border">ğŸ’§ Äá»™ áº©m (%)</th>
                    <th class="px-3 py-2 border">âš¡ Äá»™ máº·n</th>
                    <th class="px-3 py-2 border">ğŸ•’ Thá»i gian</th>
                    <th class="px-3 py-2 border">Chi tiáº¿t</th>
                  </tr>
                </thead>
                <tbody>${tableRows}</tbody>
              </table>
            </div>
          </div>
        `;

        popup.setContent(popupHtml);
        marker.openPopup();
      });

      // Khi popup má»Ÿ â†’ gáº¯n sá»± kiá»‡n click cho nÃºt "Xem"
      marker.on("popupopen", (e) => {
        setTimeout(() => {
          const popupNode = e.popup.getElement();
          if (!popupNode) return;

          const buttons = popupNode.querySelectorAll(".view-detail-btn");
          buttons.forEach(btn => {
            btn.addEventListener("click", (event) => {
              event.stopPropagation();
              const lat = parseFloat(btn.dataset.lat);
              const lon = parseFloat(btn.dataset.lon);
              const index = parseInt(btn.dataset.index);

              const item = data.find(dd => dd.latitude === lat && dd.longitude === lon)?.records[index];
              if (item) {
                alert(`ğŸ“Š Chi tiáº¿t dá»¯ liá»‡u:
ğŸŒ¡ Nhiá»‡t Ä‘á»™: ${item.temperature ?? "N/A"}Â°C
ğŸ’§ Äá»™ áº©m: ${item.humidity ?? "N/A"}%
âš¡ Äá»™ máº·n: ${item.conductivity ?? "N/A"}
ğŸ•’ ${new Date(item.timestamp).toLocaleString("vi-VN")}`);
              }
            });
          });
        }, 50);
      });
    });
  </script>
</body>

</html>
